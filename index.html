<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案管理日曆系統</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            @page {
                size: A3 landscape;
                margin: 1cm; 
            }

            body, #root {
                margin: 0;
                padding: 0;
                background: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
/* 創建左右分欄布局 */
.is-printing .print-layout {
flex-direction: row !important;
    display: flex !important;
    width: 100% !important;
    height: calc(100vh - 1cm) !important;
    max-height: calc(100vh - 1cm) !important;
    overflow: hidden !important;
}

.is-printing .printable-area {
    box-shadow: none !important;
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
    height: calc(100vh - 1cm); 
    width: 80% !important;
}

.is-printing .memo-area {
    width: 20% !important;
    height: 100% !important;
    padding: 20px !important;
    display: flex !important;
    flex-shrink: 0 !important; /* 防止被壓縮 */
    flex-direction: column !important;
    background: white !important;
}

.is-printing .memo-content {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 15px !important;
}

.is-printing .memo-section {
    margin-bottom: 10px !important;
}

.is-printing .memo-section-title {
    font-weight: bold !important;
    font-size: 16pt !important;
    margin-bottom: 5px !important;
color: #B22222 !important;
}

.is-printing .memo-item {
    font-size: 16pt !important;
    font-weight: bold !important;
    margin-bottom: 3px !important;
    padding-left: 10px !important;
}

.is-printing .memo-title {
    font-size: 18pt !important;
    font-weight: bold !important;
    margin-bottom: 15px !important;
    text-align: center !important;
    border-bottom: 1px solid #000 !important;
    padding-bottom: 5px !important;
}

.is-printing .memo-lines {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
}

.is-printing .memo-line {
    border-bottom: 1px solid #666 !important;
    height: 20px !important;
    width: 100% !important;
}

/* 確保最外層容器完全填滿 */
.is-printing .max-w-7xl {
    max-width: none !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* 確保日曆容器完全填滿 */
.is-printing .bg-white.rounded-lg.shadow-sm {
    margin: 0 !important;
    padding: 0 !important;
    border-radius: 0 !important;
    width: 100% !important;
    height: 100% !important;
}

/* 移除最外層的 padding */
.is-printing {
    padding: 0 !important;
}

/* 確保日曆週容器填滿寬度 */
.is-printing .calendar-weeks-container {
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

            .is-printing .no-print {
                display: none !important;
            }
            
            /* 議程列印樣式 */
            .is-printing .agenda-printable {
                box-shadow: none !important;
                border: none !important;
                padding: 20px !important;
                margin: 0 !important;
                background: white !important;
            }

            .is-printing .agenda-print-title {
                display: block !important;
                text-align: center;
                font-size: 18pt;
                font-weight: bold;
                margin-bottom: 20px;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }

            .is-printing .person-group {
                margin-bottom: 25px !important;
                page-break-inside: avoid;
            }

            .is-printing .person-title {
                font-size: 16pt !important;
                font-weight: bold !important;
                color: #000 !important;
                border-bottom: 1px solid #666 !important;
                padding-bottom: 8px !important;
                margin-bottom: 15px !important;
            }

            .is-printing .item-row {
                font-size: 12pt !important;
                margin-bottom: 12px !important;
                padding: 8px !important;
                border: 1px solid #ccc !important;
                border-radius: 4px !important;
                page-break-inside: avoid;
            }

            .is-printing .item-content {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
            }

            .is-printing .item-info {
                flex: 1 !important;
            }

            .is-printing .item-type {
                font-weight: bold !important;
                font-size: 13pt !important;
            }

            .is-printing .item-dates {
                font-size: 11pt !important;
                color: #666 !important;
                margin-top: 4px !important;
            }

            .is-printing .item-status {
                display: flex !important;
                align-items: center !important;
                gap: 15px !important;
                white-space: nowrap !important;
            }

            .is-printing .status-box {
                width: 12px !important;
                height: 12px !important;
                border: 2px solid #000 !important;
                display: inline-block !important;
                margin-right: 5px !important;
            }

            .is-printing .status-checked {
                background-color: #000 !important;
            }

            .is-printing .notes-line {
                border-bottom: 1px solid #000 !important;
                min-width: 120px !important;
                height: 20px !important;
                display: inline-block !important;
            }

             .is-printing, .is-printing * {
                color: #000 !important;
             }

            .is-printing .text-gray-400 {
                color: #aaa !important;
            }

            .is-printing .text-blue-600 {
                color: #2563EB !important;
            }

            .is-printing .project-bar-text {
                font-size: 12pt !important;
                line-height: 1.2 !important;
                color: white !important;
                font-weight: 500 !important;
            }
            
            .is-printing .opacity-40 { opacity: 0.6 !important; }

            .print-title { display: none; }
            .is-printing .print-title {
                display: block;
                text-align: center;
                font-size: 20pt;
                font-weight: bold;
                margin-bottom: 15px;
                height: 50px;
            }
            
            .is-printing .calendar-weeks-container {
                display: flex;
                flex-direction: column;
                height: calc(100% - 50px);
    width: 100%;
            }
            .is-printing .calendar-week-row {
                flex: 1; 
                display: flex;
                flex-direction: column;
min-height: calc((100vh - 4cm) / 6) !important; /* 平均分配6週的高度 */
            }
            .is-printing .calendar-week-row > div {
                flex: 1; 
            }
            .is-printing .calendar-week-row {
                min-height: 150px !important;
            }

            /* A3列印時的日期格子調整 */
            .is-printing .grid.grid-cols-7 > div {
                font-size: 30pt !important;
                padding: 8px !important;
            }

            /* A3列印時週標題調整 */
            .is-printing .grid.grid-cols-7.border-b > div {
                font-size: 18pt !important;
                font-weight: bold !important;
                padding: 12px !important;
            }

            /* 議程模式的A4直式設定 - 使用更具體的選擇器 */
            body.agenda-print.is-printing @page {
                size: A4 portrait !important;
                margin: 1.5cm !important;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const ProjectCalendar = () => {
            // 所有狀態定義
            const [currentProject, setCurrentProject] = useState('');
            const [showProjectSetup, setShowProjectSetup] = useState(true);
            const [tempProjectName, setTempProjectName] = useState('');
            const [currentDate, setCurrentDate] = useState(new Date(2025, 6, 1));
            const [viewMode, setViewMode] = useState('month');
            const [items, setItems] = useState([]);
            const [showAddForm, setShowAddForm] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [showEditForm, setShowEditForm] = useState(false);
            const [showTypeManager, setShowTypeManager] = useState(false);
            const [showExportManager, setShowExportManager] = useState(false);
            const [showProjectManager, setShowProjectManager] = useState(false);
            const [allProjects, setAllProjects] = useState([]);
            const [isPrinting, setIsPrinting] = useState(false);
            const [showUserInProgressBar, setShowUserInProgressBar] = useState(false);
            const [itemTypes, setItemTypes] = useState([
                { name: '重要', color: 'bg-red-500' },
                { name: '技師', color: 'bg-green-500' },
                { name: '圖說', color: 'bg-blue-500' },
                { name: '報告書', color: 'bg-yellow-500' },
                { name: '簡報', color: 'bg-purple-500' },
                { name: '預算', color: 'bg-teal-500' },
                { name: '規範', color: 'bg-orange-500' },
                { name: '因應', color: 'bg-indigo-500' },
                { name: '行政', color: 'bg-gray-500' },
                { name: '跑照', color: 'bg-pink-500' },
            ]);
            const [newType, setNewType] = useState({ name: '', color: 'bg-blue-500' });
            const [newItem, setNewItem] = useState({
                responsiblePerson: '',
                type: '',
                detail: '',
                startDate: '',
                endDate: '',
                status: '', // 'completed' or 'incomplete' or ''
                notes: ''
            });

            const availableColors = [
                'bg-red-500', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500', 
                'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500',
                'bg-orange-500', 'bg-gray-500', 'bg-cyan-500', 'bg-lime-500'
            ];

            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];

            // 載入所有專案
            const loadAllProjects = () => {
                const projects = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('projects_')) {
                        const projectName = key.replace('projects_', '');
                        projects.push(projectName);
                    }
                }
                setAllProjects(projects);
                return projects;
            };

            useEffect(() => {
                loadAllProjects();
            }, []);

            // 刪除專案資料
            const handleDeleteProject = (projectName) => {
                if (confirm(`確定要刪除專案「${projectName}」的所有資料嗎？此操作無法復原！`)) {
                    const projectKey = `projects_${projectName}`;
                    localStorage.removeItem(projectKey);
                    
                    // 更新專案列表
                    const updatedProjects = loadAllProjects();
                    
                    // 如果刪除的是當前專案，回到專案設定頁面
                    if (projectName === currentProject) {
                        setCurrentProject('');
                        setShowProjectSetup(true);
                        setItems([]);
                        setItemTypes([
                            { name: '重要', color: 'bg-red-500' },
                            { name: '技師', color: 'bg-green-500' },
                            { name: '圖說', color: 'bg-blue-500' },
                            { name: '報告書', color: 'bg-yellow-500' },
                            { name: '簡報', color: 'bg-purple-500' },
                            { name: '預算', color: 'bg-teal-500' },
                            { name: '規範', color: 'bg-orange-500' },
                            { name: '因應', color: 'bg-indigo-500' },
                            { name: '行政', color: 'bg-gray-500' },
                            { name: '跑照', color: 'bg-pink-500' },
                        ]);
                    }
                    
                    alert(`專案「${projectName}」的資料已刪除`);
                }
            };

            // 清空當前專案所有項目
            const handleClearCurrentProjectItems = () => {
                if (confirm(`確定要清空專案「${currentProject}」的所有項目嗎？此操作無法復原！`)) {
                    setItems([]);
                    saveItems([], itemTypes);
                    alert('所有項目已清空');
                }
            };

            const handleProjectSetup = () => {
                if (!tempProjectName.trim()) return;
                const projectName = tempProjectName.trim();
                setCurrentProject(projectName);
                setShowProjectSetup(false);
                
                const projectKey = `projects_${projectName}`;
                const savedData = localStorage.getItem(projectKey);
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        const itemsWithDates = parsed.projects?.map(p => ({
                            ...p,
                            startDate: new Date(p.startDate),
                            endDate: new Date(p.endDate),
                            detail: p.detail || '',
                            creator: p.creator || projectName
                        })) || [];
                        setItems(itemsWithDates);
                        setItemTypes(parsed.projectTypes || itemTypes);
                    } catch (e) {
                        console.error('載入資料失敗:', e);
                    }
                }else {
                    // *** 新增的 else 區塊 ***
                    // 如果是全新專案，清空項目並使用預設類型
                    setItems([]);
                    setItemTypes([
                        { name: '重要', color: 'bg-red-500' },
                        { name: '技師', color: 'bg-green-500' },
                        { name: '圖說', color: 'bg-blue-500' },
                        { name: '報告書', color: 'bg-yellow-500' },
                        { name: '簡報', color: 'bg-purple-500' },
                        { name: '預算', color: 'bg-teal-500' },
                        { name: '規範', color: 'bg-orange-500' },
                        { name: '因應', color: 'bg-indigo-500' },
                        { name: '行政', color: 'bg-gray-500' },
                        { name: '跑照', color: 'bg-pink-500' },
                ]);
                }
                if (!allProjects.includes(projectName)) {
                    setAllProjects([...allProjects, projectName]);
                }
            };

            const saveItems = (itemList, typeList) => {
                if (currentProject) {
                    const projectKey = `projects_${currentProject}`;
                    const data = {
                        projects: itemList,
                        projectTypes: typeList || itemTypes
                    };
                    localStorage.setItem(projectKey, JSON.stringify(data));
                }
            };
            
            const handlePrint = () => {
                setIsPrinting(true);
                if (viewMode === 'agenda') {
                    // 議程檢視使用A4直式
                    document.body.classList.add('agenda-print');
                    // 動態插入A4直式的CSS規則
                    const style = document.createElement('style');
                    style.id = 'agenda-print-style';
                    style.textContent = `
                        @media print {
                            @page {
                                size: A4 portrait !important;
                                margin: 1.5cm !important;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                setTimeout(() => {
                    window.print();
                    setIsPrinting(false);
                    if (viewMode === 'agenda') {
                        document.body.classList.remove('agenda-print');
                        // 移除動態CSS
                        const style = document.getElementById('agenda-print-style');
                        if (style) {
                            document.head.removeChild(style);
                        }
                    }
                }, 500);
            };

            const handleAddItem = () => {
                if (!newItem.responsiblePerson || !newItem.startDate || !newItem.endDate) return;
                
                const typeInfo = itemTypes.find(t => t.name === newItem.type);
                const item = {
                    id: Date.now(),
                    title: newItem.responsiblePerson,
                    type: newItem.type,
                    detail: newItem.detail,
                    startDate: new Date(newItem.startDate),
                    endDate: new Date(newItem.endDate),
                    color: typeInfo?.color || 'bg-blue-500',
                    creator: currentProject,
                    status: '',
                    notes: ''
                };
                
                const newItems = [...items, item];
                setItems(newItems);
                saveItems(newItems, itemTypes);
                
                setNewItem({
                    responsiblePerson: '',
                    type: itemTypes.length > 0 ? itemTypes[0].name : '',
                    detail: '',
                    startDate: '',
                    endDate: '',
                    status: '',
                    notes: ''
                });
                setShowAddForm(false);
            };

            const handleAddType = () => {
                if (newType.name.trim()) {
                    const type = {
                        name: newType.name.trim(),
                        color: newType.color
                    };
                    const newTypes = [...itemTypes, type];
                    setItemTypes(newTypes);
                    saveItems(items, newTypes);
                    setNewType({ name: '', color: 'bg-blue-500' });
                }
            };

            const handleDeleteType = (typeName) => {
                const isTypeInUse = items.some(item => item.type === typeName);
                if (isTypeInUse) {
                    alert('無法刪除：仍有項目使用此類型');
                    return;
                }
                const newTypes = itemTypes.filter(type => type.name !== typeName);
                setItemTypes(newTypes);
                saveItems(items, newTypes);
            };

            const exportData = () => {
                const dataStr = JSON.stringify({
                    project: currentProject,
                    projects: items,
                    projectTypes: itemTypes,
                    exportDate: new Date().toISOString()
                }, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `專案日曆_${currentProject}_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            if (imported.projects && imported.projectTypes) {
                                const itemsWithDates = imported.projects.map(project => ({
                                    ...project,
                                    startDate: new Date(project.startDate),
                                    endDate: new Date(project.endDate),
                                    detail: project.detail || '',
                                    creator: project.creator || imported.project || '未知專案'
                                }));
                                
                                const mergedItems = [...items];
                                const mergedTypes = [...itemTypes];
                                
                                imported.projectTypes.forEach(importedType => {
                                    if (!mergedTypes.find(t => t.name === importedType.name)) {
                                        mergedTypes.push(importedType);
                                    }
                                });
                                
                                itemsWithDates.forEach(importedItem => {
                                    mergedItems.push({
                                        ...importedItem,
                                        id: Date.now() + Math.random()
                                    });
                                });
                                
                                setItems(mergedItems);
                                setItemTypes(mergedTypes);
                                saveItems(mergedItems, mergedTypes);
                                alert(`成功導入 ${itemsWithDates.length} 個項目！`);
                            } else {
                                alert('檔案格式不正確！');
                            }
                        } catch (error) {
                            alert('檔案讀取失敗，請確認格式正確！');
                        }
                    };
                    reader.readAsText(file);
                }
                event.target.value = '';
            };

            const handleEditItem = (item) => {
                setSelectedItem({
                    ...item,
                    responsiblePerson: item.title,
                    startDate: item.startDate.toISOString().split('T')[0],
                    endDate: item.endDate.toISOString().split('T')[0],
                    detail: item.detail || '',
                    status: item.status || '',
                    notes: item.notes || ''
                });
                setShowEditForm(true);
            };

            const handleUpdateItem = () => {
                if (selectedItem.responsiblePerson && selectedItem.startDate && selectedItem.endDate) {
                    const typeInfo = itemTypes.find(t => t.name === selectedItem.type);
                    const updatedItem = {
                        ...selectedItem,
                        title: selectedItem.responsiblePerson,
                        startDate: new Date(selectedItem.startDate),
                        endDate: new Date(selectedItem.endDate),
                        color: typeInfo?.color || 'bg-blue-500'
                    };
                    
                    const newItems = items.map(p => p.id === selectedItem.id ? updatedItem : p);
                    setItems(newItems);
                    saveItems(newItems, itemTypes);
                    setShowEditForm(false);
                    setSelectedItem(null);
                }
            };

            const handleUpdateItemStatus = (itemId, status, notes = '') => {
                const newItems = items.map(item => 
                    item.id === itemId 
                        ? { ...item, status, notes }
                        : item
                );
                setItems(newItems);
                saveItems(newItems, itemTypes);
            };

            const handleDeleteItem = (itemId) => {
                const newItems = items.filter(p => p.id !== itemId);
                setItems(newItems);
                saveItems(newItems, itemTypes);
                setShowEditForm(false);
                setSelectedItem(null);
            };

            const navigateMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + direction);
                setCurrentDate(newDate);
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();

                const firstDayOfMonth = new Date(year, month, 1);
                const gridStartDate = new Date(firstDayOfMonth);
                gridStartDate.setDate(gridStartDate.getDate() - firstDayOfMonth.getDay());

                const lastDayOfMonth = new Date(year, month + 1, 0);
                const gridEndDate = new Date(lastDayOfMonth);
                gridEndDate.setDate(gridEndDate.getDate() + (6 - lastDayOfMonth.getDay()));

                const days = [];
                let current = new Date(gridStartDate);
                while (current <= gridEndDate) {
                    days.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                }
                
                return days;
            };

            const calculateItemSegments = (item, week) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const itemStart = new Date(item.startDate);
                const itemEnd = new Date(item.endDate);
                const weekStart = new Date(week[0]);
                const weekEnd = new Date(week[6]);

                if (itemEnd < weekStart || itemStart > weekEnd) {
                    return null;
                }

                let startDay = 0;
                let endDay = 6;

                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(week[i]);
                    if (dayDate.toDateString() === itemStart.toDateString()) {
                        startDay = i;
                        break;
                    } else if (itemStart < dayDate) {
                        startDay = Math.max(0, i - 1);
                        break;
                    }
                }

                for (let i = 6; i >= 0; i--) {
                    const dayDate = new Date(week[i]);
                    if (dayDate.toDateString() === itemEnd.toDateString()) {
                        endDay = i;
                        break;
                    } else if (itemEnd > dayDate) {
                        endDay = Math.min(6, i + 1);
                        break;
                    }
                }

                if (itemStart < weekStart) startDay = 0;
                if (itemEnd > weekEnd) endDay = 6;

                const isExpired = itemEnd < today;
                const isOngoing = itemStart <= today && itemEnd >= today;

                if (isExpired) {
                    return [{
                        left: `${(startDay) * 14.285714}%`,
                        width: `${(endDay - startDay + 1) * 14.285714}%`,
                        startDay,
                        endDay,
                        isExpired: true,
                        isOngoing: false
                    }];
                } else if (isOngoing) {
                    const segments = [];
                    let todayInWeek = -1;
                    
                    for (let i = 0; i < 7; i++) {
                        const dayDate = new Date(week[i]);
                        dayDate.setHours(0, 0, 0, 0);
                        if (dayDate.getTime() === today.getTime()) {
                            todayInWeek = i;
                            break;
                        }
                    }

                    const todayInThisWeek = today >= weekStart && today <= weekEnd;

                    if (todayInThisWeek && todayInWeek >= 0) {
                        if (startDay < todayInWeek) {
                            segments.push({
                                left: `${(startDay) * 14.285714}%`,
                                width: `${(todayInWeek - startDay) * 14.285714}%`,
                                startDay: startDay,
                                endDay: todayInWeek - 1,
                                isExpired: true,
                                isOngoing: false
                            });
                        }
                        
                        if (todayInWeek <= endDay) {
                            segments.push({
                                left: `${(todayInWeek) * 14.285714}%`,
                                width: `${(endDay - todayInWeek + 1) * 14.285714}%`,
                                startDay: todayInWeek,
                                endDay: endDay,
                                isExpired: false,
                                isOngoing: true
                            });
                        }
                    } else if (weekEnd < today) {
                        segments.push({
                            left: `${(startDay) * 14.285714}%`,
                            width: `${(endDay - startDay + 1) * 14.285714}%`,
                            startDay,
                            endDay,
                            isExpired: true,
                            isOngoing: false
                        });
                    } else {
                        segments.push({
                            left: `${(startDay) * 14.285714}%`,
                            width: `${(endDay - startDay + 1) * 14.285714}%`,
                            startDay,
                            endDay,
                            isExpired: false,
                            isOngoing: true
                        });
                    }
                    
                    return segments;
                } else {
                    return [{
                        left: `${(startDay) * 14.285714}%`,
                        width: `${(endDay - startDay + 1) * 14.285714}%`,
                        startDay,
                        endDay,
                        isExpired: false,
                        isOngoing: false
                    }];
                }
            };

            if (showProjectSetup) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="bg-white p-8 rounded-lg shadow-lg w-96">
                            <h1 className="text-2xl font-bold text-center mb-6 text-gray-800">
                                專案管理日曆系統
                            </h1>
                            <p className="text-gray-600 text-center mb-6">
                                請輸入專案名稱以開始使用
                            </p>
                            
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    value={tempProjectName}
                                    onChange={(e) => setTempProjectName(e.target.value)}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                                    placeholder="例如：北投穀倉二期、台大心智病房"
                                    onKeyPress={(e) => e.key === 'Enter' && handleProjectSetup()}
                                />
                                <button
                                    onClick={handleProjectSetup}
                                    disabled={!tempProjectName.trim()}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 text-lg font-medium"
                                >
                                    開始使用
                                </button>
                            </div>
                            
                            {allProjects.length > 0 && (
                                <div className="mt-6 pt-4 border-t">
                                    <div className="flex items-center justify-between mb-3">
                                        <p className="text-sm text-gray-600">既有專案：</p>
                                        <button
                                            onClick={() => setShowProjectManager(true)}
                                            className="text-xs text-red-600 hover:text-red-800 transition-colors"
                                        >
                                            管理專案
                                        </button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {allProjects.map(project => (
                                            <button
                                                key={project}
                                                onClick={() => {
                                                    setTempProjectName(project);
                                                    const projectName = project.trim();
                                                    setCurrentProject(projectName);
                                                    setShowProjectSetup(false);
                                                    
                                                    const projectKey = `projects_${projectName}`;
                                                    const savedData = localStorage.getItem(projectKey);
                                                    if (savedData) {
                                                        try {
                                                            const parsed = JSON.parse(savedData);
                                                            const itemsWithDates = parsed.projects?.map(p => ({
                                                                ...p,
                                                                startDate: new Date(p.startDate),
                                                                endDate: new Date(p.endDate),
                                                                detail: p.detail || '',
                                                                creator: p.creator || projectName
                                                            })) || [];
                                                            setItems(itemsWithDates);
                                                            setItemTypes(parsed.projectTypes || itemTypes);
                                                        } catch (e) {
                                                            console.error('載入資料失敗:', e);
                                                        }
                                                    } else {
                                                        setItems([]);
                                                        setItemTypes([
                                                            { name: '重要', color: 'bg-red-500' },
                                                            { name: '技師', color: 'bg-green-500' },
                                                            { name: '圖說', color: 'bg-blue-500' },
                                                            { name: '報告書', color: 'bg-yellow-500' },
                                                            { name: '簡報', color: 'bg-purple-500' },
                                                            { name: '預算', color: 'bg-teal-500' },
                                                            { name: '規範', color: 'bg-orange-500' },
                                                            { name: '因應', color: 'bg-indigo-500' },
                                                            { name: '行政', color: 'bg-gray-500' },
                                                            { name: '跑照', color: 'bg-pink-500' },
                                                        ]);
                                                    }
                                                }}
                                                className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors"
                                            >
                                                {project}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* 專案管理彈窗 */}
                        {showProjectManager && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-[500px] max-w-90vw max-h-[80vh] overflow-y-auto">
                                    <h3 className="text-lg font-semibold mb-4 text-red-600">⚠️ 專案資料管理</h3>
                                    
                                    <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <p className="text-sm text-yellow-800">
                                            <strong>注意：</strong>刪除操作無法復原，請謹慎操作！建議在刪除前先匯出資料作為備份。
                                        </p>
                                    </div>

                                    <div className="space-y-3">
                                        <h4 className="font-medium text-gray-800">所有專案：</h4>
                                        {allProjects.length === 0 ? (
                                            <p className="text-gray-500 text-center py-4">沒有找到任何專案資料</p>
                                        ) : (
                                            allProjects.map(project => {
                                                // 獲取該專案的項目數量
                                                let itemCount = 0;
                                                try {
                                                    const projectData = localStorage.getItem(`projects_${project}`);
                                                    if (projectData) {
                                                        const parsed = JSON.parse(projectData);
                                                        itemCount = parsed.projects?.length || 0;
                                                    }
                                                } catch (e) {
                                                    itemCount = 0;
                                                }

                                                return (
                                                    <div key={project} className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                                                        <div>
                                                            <span className="font-medium">{project}</span>
                                                            <span className="text-sm text-gray-500 ml-2">
                                                                ({itemCount} 個項目)
                                                            </span>
                                                        </div>
                                                        <button
                                                            onClick={() => handleDeleteProject(project)}
                                                            className="px-3 py-1 bg-red-100 text-red-600 hover:bg-red-200 rounded text-sm transition-colors"
                                                        >
                                                            刪除
                                                        </button>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>

                                    <div className="flex space-x-3 mt-6">
                                        <button
                                            onClick={() => setShowProjectManager(false)}
                                            className="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50 transition-colors"
                                        >
                                            關閉
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            const days = getDaysInMonth(currentDate);
            const weeks = [];
            for (let i = 0; i < days.length; i += 7) {
                weeks.push(days.slice(i, i + 7));
            }

            return (
                <div className={`min-h-screen bg-gray-50 p-4 ${isPrinting ? 'is-printing' : ''}`}>
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-sm mb-6 p-4 no-print">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center space-x-4 flex-wrap">
                                    <div className="flex items-center space-x-2">
                                        <span className="font-medium text-lg">專案：{currentProject}</span>
                                        <button
                                            onClick={() => setShowProjectSetup(true)}
                                            className="text-sm text-blue-600 hover:text-blue-800 transition-colors"
                                        >
                                            切換專案
                                        </button>
                                    </div>

                                    <button onClick={() => setShowAddForm(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"> + 新增項目 </button>
                                    <button onClick={() => setShowTypeManager(true)} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"> 管理類型 </button>
                                    <button onClick={() => setShowExportManager(true)} className="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors"> 匯出/導入 </button>
                                    <button 
                                        onClick={() => setShowUserInProgressBar(!showUserInProgressBar)} 
                                        className={`px-4 py-2 rounded-lg transition-colors ${showUserInProgressBar ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                                        title={showUserInProgressBar ? '點擊隱藏專案名' : '點擊顯示專案名'}
                                    > 
                                        {showUserInProgressBar ? '隱藏專案名' : '顯示專案名'} 
                                    </button>
                                    
                                    <button 
                                        onClick={handleClearCurrentProjectItems}
                                        className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
                                        title="清空當前專案的所有項目"
                                    > 
                                        清空項目 
                                    </button>
                                    
                                    <button onClick={handlePrint} className="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors"> 
                                        {viewMode === 'month' ? '列印月曆' : '列印負責人清單'} 
                                    </button>
                                    
                                    <div className="flex items-center space-x-2">
                                        <button onClick={() => navigateMonth(-1)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors text-xl"> ← </button>
                                        <h1 className="text-xl font-semibold"> {currentDate.getFullYear()}年{monthNames[currentDate.getMonth()]} </h1>
                                        <button onClick={() => navigateMonth(1)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors text-xl"> → </button>
                                    </div>
                                </div>

                                <div className="flex space-x-2">
                                    <button onClick={() => setViewMode('month')} className={`px-3 py-1 text-sm border rounded transition-colors ${ viewMode === 'month' ? 'bg-blue-600 text-white' : 'hover:bg-gray-50' }`}> 月 </button>
                                    <button onClick={() => setViewMode('agenda')} className={`px-3 py-1 text-sm border rounded transition-colors ${ viewMode === 'agenda' ? 'bg-blue-600 text-white' : 'hover:bg-gray-50' }`}> 負責人 </button>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-4 text-sm">
                                {itemTypes.map((type) => (
                                    <div key={type.name} className="flex items-center space-x-2">
                                        <div className={`w-3 h-3 rounded ${type.color}`}></div>
                                        <span className="text-gray-700">{type.name}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

{viewMode === 'month' && (
    <div className="print-layout">
        <div className="bg-white rounded-lg shadow-sm printable-area">
            <div className="print-title">
                專案：{currentProject} - {currentDate.getFullYear()}年 {monthNames[currentDate.getMonth()]}
            </div>
            <div className="grid grid-cols-7 border-b">
                {weekDays.map((day) => (
                    <div key={day} className="p-2 md:p-6 text-center font-medium text-gray-600 border-r last:border-r-0">
                        {day}
                    </div>
                ))}
            </div>

            <div className="relative calendar-weeks-container">
                {weeks.map((week, weekIndex) => (
                    <div key={weekIndex} className="relative calendar-week-row">
                        <div className="grid grid-cols-7 border-b last:border-b-0" style={{ minHeight: isPrinting ? 'auto' : '200px' }}>
                            {week.map((day) => {
                                const isCurrentMonth = day.getMonth() === currentDate.getMonth();
                                const isToday = day.toDateString() === new Date().toDateString();
                                
                                return (
                                    <div
                                        key={day.toISOString()}
                                        className={`border-r last:border-r-0 p-3 ${ !isCurrentMonth ? 'bg-gray-50 text-gray-400' : '' } ${isToday && !isPrinting ? 'bg-blue-50' : ''}`}
                                        style={{ minHeight: isPrinting ? 'auto' : '200px' }}
                                    >
                                        <div className={`text-base mb-2 ${isToday ? 'font-bold text-blue-600' : ''}`}>
                                            {day.getDate()}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="absolute inset-0 pointer-events-none">
                            <div className="relative h-full w-full">
                                {(() => {
                                    const weekItems = items.filter(item => calculateItemSegments(item, week) !== null);
                                    const itemLayers = [];
                                    weekItems.forEach(item => {
                                        const segments = calculateItemSegments(item, week);
                                        if (segments) {
                                            let layerIndex = 0;
                                            while (itemLayers[layerIndex] && 
                                                   itemLayers[layerIndex].some(existingItem => {
                                                     const existingSegments = calculateItemSegments(existingItem, week);
                                                     if (!existingSegments) return false;
                                                     return segments.some(seg => existingSegments.some(existingSeg => !(seg.endDay < existingSeg.startDay || seg.startDay > existingSeg.endDay)));
                                                   })) {
                                              layerIndex++;
                                            }
                                            if (!itemLayers[layerIndex]) itemLayers[layerIndex] = [];
                                            itemLayers[layerIndex].push(item);
                                        }
                                    });

                                    return itemLayers.map((layer, layerIndex) => 
                                        layer.map(item => {
                                            const segments = calculateItemSegments(item, week);
                                            if (!segments) return null;
                                            
                                            return segments.map((segment, segmentIndex) => {
                                                const displayText = item.detail 
                                                    ? `${item.title}:${item.type}-${item.detail}${showUserInProgressBar ? `(${item.creator || '未知'})` : ''}`
                                                    : `${item.title}:${item.type}${showUserInProgressBar ? `(${item.creator || '未知'})` : ''}`;
                                                
                                                const topPosition = isPrinting ? (35 + layerIndex * 24) : (45 + layerIndex * 32);
                                                const height = isPrinting ? '22px' : '28px';
                                                const padding = isPrinting ? 'px-2 py-1' : 'px-3 py-2';
                                                
                                                return (
                                                    <div
                                                        key={`${item.id}-${segmentIndex}`}
                                                        className={`absolute ${item.color} text-white text-sm ${padding} rounded shadow-sm hover:shadow-md transition-all cursor-pointer pointer-events-auto ${ segment.isExpired ? 'opacity-40' : 'opacity-90 hover:opacity-100' }`}
                                                        style={{ left: segment.left, width: segment.width, top: `${topPosition}px`, height: height, zIndex: 10 }}
                                                        title={`${displayText} ${segment.isExpired ? '- 已過期' : segment.isOngoing ? '- 進行中' : ''}`}
                                                        onClick={() => handleEditItem(item)}
                                                    >
                                                        <div className="truncate leading-tight project-bar-text"> {displayText} </div>
                                                    </div>
                                                );
                                            });
                                        })
                                    );
                                })()}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>

<div className="memo-area" style={{ display: isPrinting ? 'flex' : 'none' }}>
    <div className="memo-content">
        <div className="memo-section">
            <div className="memo-section-title"> </div>
            <div className="memo-section-title">新建/歷建圖面(現況、修復)</div>
            <div className="memo-item">A0基本資料(位置、面積)</div>
            <div className="memo-item">A1假設工程、發包事項</div>
            <div className="memo-item">A2平面圖</div>
            <div className="memo-item">A3立面圖</div>
            <div className="memo-item">A4剖面圖</div>
            <div className="memo-item">A5樓梯電梯圖</div>
            <div className="memo-item">A6門窗圖</div>
            <div className="memo-item">A7細部圖</div>
            <div className="memo-item">A8自訂擴充</div>
            <div className="memo-item">A9自訂擴充</div>
            <div className="memo-item">S結構圖</div>
            <div className="memo-item">EPW機電圖</div>
            <div className="memo-item">F消防圖</div>
            <div className="memo-item">M空調圖</div>
        </div>
        
        <div className="memo-section">
            <div className="memo-section-title">預算</div>
            <div className="memo-item">總表</div>
            <div className="memo-item">詳細表</div>
            <div className="memo-item">數量計算表</div>
            <div className="memo-item">資源統計表</div>
            <div className="memo-item">PCCES</div>
        </div>
        
        <div className="memo-section">
            <div className="memo-section-title">技師</div>
            <div className="memo-item">一個月前給平面圖</div>
            <div className="memo-item">第三個禮拜交圖先整合</div>
            <div className="memo-item">第四個禮拜交預算</div>
        </div>
    </div>
</div>



    </div>
)}




                        {viewMode === 'agenda' && (
                            <div className={`bg-white rounded-lg shadow-sm p-6 agenda-printable ${isPrinting ? '' : 'no-print'}`}>
                                <div className="agenda-print-title" style={{ display: 'none' }}>
                                    專案：{currentProject}
                                </div>
                                <h2 className="text-lg font-semibold mb-4">負責人檢視</h2>
                                <div className="space-y-6">
                                    {(() => {
                                        // 按負責人分組
                                        const groupedItems = items.reduce((groups, item) => {
                                            const responsiblePerson = item.title || '未指定負責人';
                                            if (!groups[responsiblePerson]) {
                                                groups[responsiblePerson] = [];
                                            }
                                            groups[responsiblePerson].push(item);
                                            return groups;
                                        }, {});

                                        // 對每個分組內的項目按開始日期排序
                                        Object.keys(groupedItems).forEach(person => {
                                            groupedItems[person].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                                        });

                                        // 按負責人名稱排序
                                        const sortedPersons = Object.keys(groupedItems).sort();

                                        return sortedPersons.map(person => (
                                            <div key={person} className="border rounded-lg p-4 person-group">
                                                <h3 className="text-lg font-semibold mb-3 text-blue-600 border-b pb-2 person-title">
                                                    {person}
                                                </h3>
                                                <div className="space-y-2">
                                                    {groupedItems[person].map(item => {
                                                        const today = new Date(); 
                                                        today.setHours(0, 0, 0, 0);
                                                        const isExpired = new Date(item.endDate) < today;
                                                        const isCompleted = item.status === 'completed';
                                                        const isIncomplete = item.status === 'incomplete';
                                                        
                                                        
                                                        return (
                                                            <div 
                                                                key={item.id} 
                                                                className={`border rounded-lg p-3 ml-4 item-row ${ isExpired ? 'opacity-50' : '' } ${
                                                                    isCompleted ? 'bg-green-50 border-green-200' : 
                                                                    isIncomplete ? 'bg-red-50 border-red-200' : 'bg-white'
                                                                }`}
                                                            >
                                                                <div className="flex items-center space-x-3 item-content">
                                                                    <div className={`w-4 h-4 rounded ${item.color}`}></div>
                                                                    <div className="flex-1 item-info">
                                                                        <div className="flex items-center space-x-2">
                                                                            <span className={`font-medium item-type ${isCompleted ? 'line-through text-gray-500' : ''}`}>
                                                                                {item.type}
                                                                            </span>
                                                                            {item.detail && <span className={`text-gray-600 ${isCompleted ? 'line-through' : ''}`}>- {item.detail}</span>}
                                                                        </div>
                                                                        <div className="text-sm text-gray-500 mt-1 item-dates">
                                                                            {item.startDate.toLocaleDateString('zh-TW')} - {item.endDate.toLocaleDateString('zh-TW')}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* 狀態選擇和備註在右側 */}
                                                                    <div className="flex items-center space-x-4 item-status">
                                                                        <label className="flex items-center space-x-1 cursor-pointer">
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={isCompleted}
                                                                                onChange={(e) => {
                                                                                    if (e.target.checked) {
                                                                                        handleUpdateItemStatus(item.id, 'completed', item.notes || '');
                                                                                    } else {
                                                                                        handleUpdateItemStatus(item.id, '', item.notes || '');
                                                                                    }
                                                                                }}
                                                                                className="w-4 h-4 text-green-600 rounded focus:ring-green-500 status-box"
                                                                            />
                                                                            <span className="text-sm text-green-600 font-medium">完成</span>
                                                                        </label>
                                                                        
                                                                        <label className="flex items-center space-x-1 cursor-pointer">
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={isIncomplete}
                                                                                onChange={(e) => {
                                                                                    if (e.target.checked) {
                                                                                        handleUpdateItemStatus(item.id, 'incomplete', item.notes || '');
                                                                                    } else {
                                                                                        handleUpdateItemStatus(item.id, '', item.notes || '');
                                                                                    }
                                                                                }}
                                                                                className="w-4 h-4 text-red-600 rounded focus:ring-red-500 status-box"
                                                                            />
                                                                            <span className="text-sm text-red-600 font-medium">未完成</span>
                                                                        </label>
                                                                        
                                                                        <input
                                                                            type="text"
                                                                            value={item.notes || ''}
                                                                            onChange={(e) => handleUpdateItemStatus(item.id, item.status || '', e.target.value)}
                                                                            className="w-64 text-sm border-b border-gray-300 bg-transparent focus:outline-none focus:border-blue-500 px-2 py-1 notes-line"
                                                                            placeholder="備註..."
                                                                        />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ));
                                    })()}
                                </div>
                            </div>
                        )}

                        {/* 新增項目對話框 */}
                        {showAddForm && ( 
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print"> 
                                <div className="bg-white rounded-lg p-6 w-96"> 
                                    <h3 className="text-lg font-semibold mb-4">新增項目</h3> 
                                    <div className="space-y-4"> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">項目負責人</label> 
                                            <input 
                                                type="text" 
                                                value={newItem.responsiblePerson} 
                                                onChange={(e) => setNewItem({...newItem, responsiblePerson: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                placeholder="輸入負責人姓名"
                                            /> 
                                        </div> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">項目類型</label> 
                                            <select 
                                                value={newItem.type} 
                                                onChange={(e) => setNewItem({...newItem, type: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            > 
                                                <option value="">請選擇類型</option> 
                                                {itemTypes.map(type => ( 
                                                    <option key={type.name} value={type.name}>{type.name}</option> 
                                                ))} 
                                            </select> 
                                        </div> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">細項</label> 
                                            <input 
                                                type="text" 
                                                value={newItem.detail} 
                                                onChange={(e) => setNewItem({...newItem, detail: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                placeholder="輸入項目細項 (選填)"
                                            /> 
                                        </div> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">開始日期</label> 
                                            <input 
                                                type="date" 
                                                value={newItem.startDate} 
                                                onChange={(e) => setNewItem({...newItem, startDate: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            /> 
                                        </div> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">結束日期</label> 
                                            <input 
                                                type="date" 
                                                value={newItem.endDate} 
                                                onChange={(e) => setNewItem({...newItem, endDate: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            /> 
                                        </div> 
                                    </div> 
                                    <div className="flex space-x-3 mt-6"> 
                                        <button 
                                            onClick={handleAddItem} 
                                            className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                        > 
                                            新增 
                                        </button> 
                                        <button 
                                            onClick={() => { 
                                                setShowAddForm(false); 
                                                setNewItem({ 
                                                    responsiblePerson: '', 
                                                    type: itemTypes.length > 0 ? itemTypes[0].name : '', 
                                                    detail: '', 
                                                    startDate: '', 
                                                    endDate: '',
                                                    status: '',
                                                    notes: ''
                                                }); 
                                            }} 
                                            className="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50 transition-colors"
                                        > 
                                            取消 
                                        </button> 
                                    </div> 
                                </div> 
                            </div> 
                        )}
                        
                        {/* 編輯項目對話框 */}
                        {showEditForm && selectedItem && ( 
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print"> 
                                <div className="bg-white rounded-lg p-6 w-96"> 
                                    <h3 className="text-lg font-semibold mb-4">編輯項目</h3> 
                                    <div className="space-y-4"> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">項目負責人</label> 
                                            <input 
                                                type="text" 
                                                value={selectedItem.responsiblePerson || ''} 
                                                onChange={(e) => setSelectedItem({...selectedItem, responsiblePerson: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                placeholder="輸入負責人姓名"
                                            /> 
                                        </div>
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">項目類型</label> 
                                            <select 
                                                value={selectedItem.type} 
                                                onChange={(e) => setSelectedItem({...selectedItem, type: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            > 
                                                {itemTypes.map(type => ( 
                                                    <option key={type.name} value={type.name}>{type.name}</option> 
                                                ))} 
                                            </select> 
                                        </div> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">細項</label> 
                                            <input 
                                                type="text" 
                                                value={selectedItem.detail || ''} 
                                                onChange={(e) => setSelectedItem({...selectedItem, detail: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                placeholder="輸入項目細項 (選填)"
                                            /> 
                                        </div> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">開始日期</label> 
                                            <input 
                                                type="date" 
                                                value={selectedItem.startDate} 
                                                onChange={(e) => setSelectedItem({...selectedItem, startDate: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            /> 
                                        </div> 
                                        <div> 
                                            <label className="block text-sm font-medium mb-1">結束日期</label> 
                                            <input 
                                                type="date" 
                                                value={selectedItem.endDate} 
                                                onChange={(e) => setSelectedItem({...selectedItem, endDate: e.target.value})} 
                                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            /> 
                                        </div> 
                                    </div> 
                                    <div className="flex space-x-3 mt-6"> 
                                        <button 
                                            onClick={handleUpdateItem} 
                                            className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                        > 
                                            更新 
                                        </button> 
                                        <button 
                                            onClick={() => handleDeleteItem(selectedItem.id)} 
                                            className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors"
                                        > 
                                            刪除 
                                        </button> 
                                        <button 
                                            onClick={() => { 
                                                setShowEditForm(false); 
                                                setSelectedItem(null); 
                                            }} 
                                            className="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50 transition-colors"
                                        > 
                                            取消 
                                        </button> 
                                    </div> 
                                </div> 
                            </div> 
                        )}
                        
                        {/* 類型管理對話框 */}
                        {showTypeManager && ( 
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print"> 
                                <div className="bg-white rounded-lg p-6 w-[500px] max-w-90vw max-h-[80vh] overflow-y-auto"> 
                                    <h3 className="text-lg font-semibold mb-4">管理項目類型</h3> 
                                    <div className="mb-6 p-4 bg-gray-50 rounded-lg"> 
                                        <h4 className="font-medium mb-3">新增類型</h4> 
                                        <div className="space-y-3"> 
                                            <div> 
                                                <label className="block text-sm font-medium mb-1">類型名稱</label> 
                                                <input 
                                                    type="text" 
                                                    value={newType.name} 
                                                    onChange={(e) => setNewType({...newType, name: e.target.value})} 
                                                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                    placeholder="輸入類型名稱"
                                                /> 
                                            </div> 
                                            <div> 
                                                <label className="block text-sm font-medium mb-1">顏色</label> 
                                                <div className="flex flex-wrap gap-2"> 
                                                    {availableColors.map(color => ( 
                                                        <button 
                                                            key={color} 
                                                            onClick={() => setNewType({...newType, color})} 
                                                            className={`w-8 h-8 rounded ${color} border-2 transition-all ${ newType.color === color ? 'border-gray-800 scale-110' : 'border-gray-300' }`}
                                                        /> 
                                                    ))} 
                                                </div> 
                                            </div> 
                                            <button 
                                                onClick={handleAddType} 
                                                className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors"
                                            > 
                                                新增類型 
                                            </button> 
                                        </div> 
                                    </div> 
                                    <div> 
                                        <h4 className="font-medium mb-3">現有類型</h4> 
                                        <div className="space-y-2"> 
                                            {itemTypes.map((type) => { 
                                                const isInUse = items.some(item => item.type === type.name); 
                                                return ( 
                                                    <div key={type.name} className="flex items-center justify-between p-3 border rounded-lg"> 
                                                        <div className="flex items-center space-x-3"> 
                                                            <div className={`w-4 h-4 rounded ${type.color}`}></div> 
                                                            <span className="font-medium">{type.name}</span> 
                                                            {isInUse && <span className="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded">使用中</span>} 
                                                        </div> 
                                                        <button 
                                                            onClick={() => handleDeleteType(type.name)} 
                                                            disabled={isInUse} 
                                                            className={`px-3 py-1 text-sm rounded transition-colors ${ isInUse ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-red-100 text-red-600 hover:bg-red-200' }`}
                                                        > 
                                                            刪除 
                                                        </button> 
                                                    </div> 
                                                ); 
                                            })} 
                                        </div> 
                                    </div> 
                                    <div className="flex space-x-3 mt-6"> 
                                        <button 
                                            onClick={() => { 
                                                setShowTypeManager(false); 
                                                setNewType({ name: '', color: 'bg-blue-500' }); 
                                            }} 
                                            className="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50 transition-colors"
                                        > 
                                            關閉 
                                        </button> 
                                    </div> 
                                </div> 
                            </div> 
                        )}
                        
                        {/* 匯出/導入對話框 */}
                        {showExportManager && ( 
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print"> 
                                <div className="bg-white rounded-lg p-6 w-[600px] max-w-90vw max-h-[80vh] overflow-y-auto"> 
                                    <h3 className="text-lg font-semibold mb-4">資料匯出與導入</h3> 
                                    <div className="mb-6 p-4 bg-blue-50 rounded-lg"> 
                                        <h4 className="font-medium mb-3 text-blue-800">匯出專案資料</h4> 
                                        <p className="text-sm text-gray-600 mb-3"> 
                                            將您的專案資料匯出為 JSON 檔案，可在其他電腦使用或作為備份。 
                                        </p> 
                                        <button 
                                            onClick={exportData} 
                                            className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2"
                                        > 
                                            <span>📥</span> 
                                            <span>匯出專案資料</span> 
                                        </button> 
                                    </div> 
                                    <div className="mb-6 p-4 bg-green-50 rounded-lg"> 
                                        <h4 className="font-medium mb-3 text-green-800">導入資料</h4> 
                                        <p className="text-sm text-gray-600 mb-3"> 
                                            導入之前匯出的 JSON 檔案，資料會合併到您目前的專案中。 
                                        </p> 
                                        <label className="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors cursor-pointer flex items-center justify-center space-x-2"> 
                                            <span>📤</span> 
                                            <span>選擇檔案導入</span> 
                                            <input type="file" accept=".json" onChange={importData} className="hidden"/> 
                                        </label> 
                                    </div> 
                                    <div className="p-4 bg-yellow-50 rounded-lg"> 
                                        <h4 className="font-medium mb-2 text-yellow-800">📊 統計用途</h4> 
                                        <div className="text-sm text-gray-700 space-y-1"> 
                                            <p><strong>專案管理：</strong>換電腦時導入資料即可繼續使用</p> 
                                            <p><strong>團隊統計：</strong>收集所有專案的匯出檔案後，可逐一導入查看全部專案</p> 
                                            <p><strong>備份建議：</strong>建議每週匯出一次作為備份</p> 
                                        </div> 
                                    </div> 
                                    <div className="flex space-x-3 mt-6"> 
                                        <button 
                                            onClick={() => setShowExportManager(false)} 
                                            className="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50 transition-colors"
                                        > 
                                            關閉 
                                        </button> 
                                    </div> 
                                </div> 
                            </div> 
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ProjectCalendar />, document.getElementById('root'));
    </script>
</body>
</html>
